This is a simple translation of the C version to C++ without using "real" C++.

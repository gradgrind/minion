This is a rewrite of the C++ version using more C++ features.
